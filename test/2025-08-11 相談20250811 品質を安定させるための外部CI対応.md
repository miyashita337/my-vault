
# 相談20250811 品質を安定させるための外部CI対応

やりたいこと：今のワークフロー
```
{トラッカーID}

* [Claude]GoogleStatusステータス更新
* [Claude]実装
* [Claude]修正内容の報告（いったんここで止めて）
* [ユーザー]ユーザーのLGTM
* [Claude]テスト、ユニットテスト、動作確認
* [Claude]ワークフロー実行、上記トラッカーIDでワークフロー実行
* [Claude]テストやデモじゃないので全画像を対象として,
	* [Claude]抽出バッチを実行(バックグラウンド)
		１ファイルに５分以上かかる場合は、一旦ストップしてユーザーに確認させること
* [ユーザー]ダッシュボード確認
```

これをGithubのActionにレビューと動作確認とCIを肩代わりしてほしい

新しいワークフロー
やりたいこと：今のワークフロー
MR：MergeRequest（PR:PullRequestともいう）
```
{トラッカーID}

* [local/Claude]GoogleStatusステータス更新
* [local/Claude]featureブランチを切って別のブランチで開発
* [local/Claude]実装
	* [local/Claude]実装
* [local/Claude]修正内容のMRのpushとMRの作成
* [github]CIが回る
	* [github]動作チェック
	* [github]UnitTest（今あるtestディレクトリ以下のテスト全部）
		* [github]テストの中には画像抽出もあるので唯一テスト用の漫画アニメキャラクターの画像をpushするのでそれが抽出できてるかを確認すること
	* [github]QCチェック（今あるQC関係全部）
	* [local/Claude]MRの状態を確認する（5分ごとに確認）CIがすべてSUCCEEDされてるかチェック、されてないなら修正して（成功するまで何度も）「修正してのMRのpush」
* [ユーザー]ユーザーのLGTMおよびマージする
* [local/Claude]MRの状態を確認する（１０分ごとに確認）マージされてたら、次の
* [local/Claude]ワークフロー実行、上記トラッカーIDでワークフロー実行
* [local/Claude]テストやデモじゃないので全画像を対象として,抽出プログラム実行(features/extraction/commands/extract_character.py)
	* [local/Claude]抽出バッチを実行(バックグラウンド)
		１ファイルに５分以上かかる場合は、一旦ストップしてユーザーに確認させること
* [local/Claude]ダッシュボード作成
	* [local/Claude]ダッシュボード確認
		* curl http://100.123.241.106:8088/tracker/{トラッカーID}が表示できてること
		* ダッシュボード内の画像もブラウザ上で表示できてることを確認できてること
		* 画像はBase64ではなく画像パスであること
* [ユーザー]ダッシュボード確認

※重要事項
>テストの中には画像抽出もあるので唯一テスト用の漫画アニメキャラクターの画像をpushするのでそれが抽出できてるかを確認すること
>これはユーザーが用意します
>
/mnt/c/AItools/segment-anything/assets/test_demo1.jpg
/mnt/c/AItools/segment-anything/assets/test_demo2.jpg
/mnt/c/AItools/segment-anything/assets/test_demo3.jpg
これだけはcommit, push はOKにさせておきます
ユーザーが後で手動でgit操作してpushまでしておくのでClaudeはCI上でテストする画像が
./assets/test_demo1.jpg
./assets/test_demo2.jpg
./assets/test_demo3.jpg
であるということを認識していればOK、くりかえしますが、Claudeは絶対に自分の判断で画像をsegment-anythingリポジトリ内にcommit push しないようにしてください

```


これを実現させたいのですが、どうするのが一番いいですか？

以前やってた
ClaudeCodeGithubActionをもう一度復活させたほうがいい？それとも別の方法が良い？

# 不明点

判断できないところあれば何でもいいのでヒアリングしてください

特に問題なさそうなら、トラッカー起票してください
* 優先度：優先度最高



--------------

 1. CI実行環境要件
    - GPU必要性: SAM+YOLO抽出処理にGPUが必須？
いりません、CI上はあくまでもコード品質やPythonの統計上の整合性があってるかどうかをレビューするものにしたい、逆に教えてほしいSAM+YOLO抽出処理にGPUを使わない場合どんな問題が生じるのか？
    - メモリ要件: 現在のローカル環境スペック目安
spec.mdを参照、Ciでそれと同じものが用意するのが難しい場合は、メモリを食うてすとがどれか教えて

    - 実行時間制限: GitHub Actions無料枠（月2000分）で十分？

あくまでも無料枠のみ、フラグ管理一つでいつでももとに戻せれるようにして


>  2. テスト画像仕様
    - assets/test_demo*.jpgのファイルサイズ・解像度
100~500kb 解像度512x512程度

>    - 期待する抽出成功基準（成功率・品質スコア等）

最初は失敗でもいいので通したい、二回目以降は別チケットを作って成功率、品質スコアを上げるようにしたい


>	- テスト実行時間目安（3画像でどの程度？）
1画像５分以内




>  3. QCチェック範囲
    - 「今あるQC関係全部」の具体的スコープ

もしかしてQC関係のプログラムってなかったっけ？
C:\AItools\segment-anything\tests\qc　にあるものだけでいったんOK、増やしていきましょう

>    - 現在のQCスクリプトの実行時間・依存関係

１ファイル5分以上かかったらエラー、依存関係は仮想環境と同じようにDockerなどをCIで動かせれるようにlocalと同じものにさせておく

>    - 失敗時の許容基準・リトライロジック

いったんlocalでも通してるはずなのでlocalと同じqcの許容範囲にしてほしい、もしそんなものは存在しないという話なら、許容基準なんてないので、すべてOKとしてスルーさせる



>  4. ブランチ戦略
    - feature branch → main のシンプル構成で良い？
OK


>    - develop branch や release branch の必要性

個人開発なのでいらない


>    - トラッカーごとに個別ブランチ（feature/QCC-XXX-XXX）？

はい、それでOK、マージされたらトピックブランチは削除

> 5. CI失敗時の対応
エラーになったらPushoverに





