KIRO-024 定量的検証計画

 概要

 KIRO-024（サブエージェント活用ルール・Task toolマーカー機能）の効果を定量的に検証する。
 同じバグ修正タスク（WorkspaceConfig.get_workspace_base()の多作者対応）を2つの環境で実行し、ログを比較分析する。

 検証対象
 ┌───────────────────────────┬────────────────────┐
 │         検証項目          │      検証方法      │
 ├───────────────────────────┼────────────────────┤
 │ 1. マーカー出力確認       │ ユニットテスト     │
 ├───────────────────────────┼────────────────────┤
 │ 2. Task tool自動使用      │ セッションログ分析 │
 ├───────────────────────────┼────────────────────┤
 │ 3. コンテキスト肥大化防止 │ ログサイズ比較     │
 └───────────────────────────┴────────────────────┘
 実験設計

 KIRO-029（実装あり環境）

 - ベースブランチ: feature/KIRO-024-reapply
 - 作業ブランチ: feature/KIRO-029
 - 特徴: [TASK_TOOL_REQUIRED]マーカー機能あり

 KIRO-030（実装なし環境）

 - ベースブランチ: main
 - 作業ブランチ: feature/KIRO-030
 - 特徴: マーカー機能なし（比較対象）

 ログ保存場所

 /mnt/c/AItools/segment-anything/.claude/transcripts/logs/session_*.md
 /mnt/c/AItools/segment-anything/.claude/transcripts/archive/*.jsonl

 ---
 手順書1: KIRO-029（実装あり環境）

 前提条件

 - 新規Claude Codeセッションで実行すること
 - 現在のセッションとは別ウィンドウで実行

 Step 1: 環境準備

 # 1. ブランチ作成
 cd /mnt/c/AItools/segment-anything
 git checkout feature/KIRO-024-reapply
 git pull origin feature/KIRO-024-reapply
 git checkout -b feature/KIRO-029

 # 2. 現在のログファイルを記録（比較用）
 ls -la .claude/transcripts/logs/

 Step 2: ワークフロー実行

 # 1. 仮想環境アクティベート
 source sam-env/bin/activate

 # 2. ワークフロー作成
 python tools/workflow/workflow_cli.py create KIRO-029

 # 3. ステップ実行（繰り返し）
 python tools/workflow/workflow_cli.py instructions KIRO-029
 python tools/workflow/workflow_cli.py step KIRO-029

 # 4. 完了まで繰り返す
 python tools/workflow/workflow_cli.py status KIRO-029

 Step 3: 実装タスク（参考）

 バグ内容: WorkspaceConfig.get_workspace_base()の多作者対応
 - workflow_controller.pyの3関数を修正
 - get_workspace_config(tracker_id)を使用してトラッカー固有パスを取得

 Step 4: 完了後の記録

 # 1. 新しいログファイルを確認
 ls -la .claude/transcripts/logs/

 # 2. セッションID記録（ファイル名から）
 # 例: session_XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX_20260201.md

 # 3. compactコマンドでログを確定
 # Claude Codeで /compact を実行

 観察ポイント

 - [TASK_TOOL_REQUIRED]マーカーが表示されるか
 - マーカー表示後にTask toolが自動使用されるか
 - サブエージェント（Explore/general-purpose）が起動するか

 ---
 手順書2: KIRO-030（実装なし環境）

 前提条件

 - KIRO-029完了後に実行すること
 - 新規Claude Codeセッションで実行

 Step 1: 環境準備

 # 1. ブランチ作成（mainから）
 cd /mnt/c/AItools/segment-anything
 git checkout main
 git pull origin main
 git checkout -b feature/KIRO-030

 # 2. 現在のログファイルを記録（比較用）
 ls -la .claude/transcripts/logs/

 Step 2: ワークフロー実行

 # 1. 仮想環境アクティベート
 source sam-env/bin/activate

 # 2. ワークフロー作成
 python tools/workflow/workflow_cli.py create KIRO-030

 # 3. ステップ実行（繰り返し）
 python tools/workflow/workflow_cli.py instructions KIRO-030
 python tools/workflow/workflow_cli.py step KIRO-030

 # 4. 完了まで繰り返す
 python tools/workflow/workflow_cli.py status KIRO-030

 Step 3: 完了後の記録

 # 1. 新しいログファイルを確認
 ls -la .claude/transcripts/logs/

 # 2. セッションID記録

 # 3. compactコマンドでログを確定

 観察ポイント

 - [TASK_TOOL_REQUIRED]マーカーは表示されないはず
 - サブエージェント使用は手動判断になる

 ---
 定量比較分析手順

 分析対象ログ

 KIRO-029ログ: .claude/transcripts/logs/session_{KIRO-029_SESSION_ID}_*.md
 KIRO-030ログ: .claude/transcripts/logs/session_{KIRO-030_SESSION_ID}_*.md

 分析スクリプト（実行時に作成）

 # 1. ログサイズ比較
 KIRO029_LOG="session_{ID}_*.md"
 KIRO030_LOG="session_{ID}_*.md"

 echo "=== ログサイズ比較 ==="
 wc -c .claude/transcripts/logs/$KIRO029_LOG
 wc -c .claude/transcripts/logs/$KIRO030_LOG

 # 2. Task tool使用回数
 echo "=== Task tool使用回数 ==="
 grep -c "Task tool" .claude/transcripts/logs/$KIRO029_LOG || echo "0"
 grep -c "Task tool" .claude/transcripts/logs/$KIRO030_LOG || echo "0"

 # 3. サブエージェント起動回数
 echo "=== サブエージェント起動回数 ==="
 grep -c "subagent_type" .claude/transcripts/logs/$KIRO029_LOG || echo "0"
 grep -c "subagent_type" .claude/transcripts/logs/$KIRO030_LOG || echo "0"

 # 4. TASK_TOOL_REQUIREDマーカー出現回数
 echo "=== マーカー出現回数 ==="
 grep -c "TASK_TOOL_REQUIRED" .claude/transcripts/logs/$KIRO029_LOG || echo "0"
 grep -c "TASK_TOOL_REQUIRED" .claude/transcripts/logs/$KIRO030_LOG || echo "0"

 # 5. ユーザー指摘回数（手動カウント or パターンマッチ）
 echo "=== エラー/修正パターン ==="
 grep -c -E "エラー|間違|修正して|違う" .claude/transcripts/logs/$KIRO029_LOG || echo "0"
 grep -c -E "エラー|間違|修正して|違う" .claude/transcripts/logs/$KIRO030_LOG || echo "0"

 比較指標
 ┌──────────────────────────┬──────────┬──────────┬──────┐
 │           指標           │ KIRO-029 │ KIRO-030 │ 差分 │
 ├──────────────────────────┼──────────┼──────────┼──────┤
 │ ログサイズ(bytes)        │ -        │ -        │ -%   │
 ├──────────────────────────┼──────────┼──────────┼──────┤
 │ Task tool使用回数        │ -        │ -        │ -    │
 ├──────────────────────────┼──────────┼──────────┼──────┤
 │ サブエージェント起動回数 │ -        │ -        │ -    │
 ├──────────────────────────┼──────────┼──────────┼──────┤
 │ マーカー出現回数         │ -        │ -        │ -    │
 ├──────────────────────────┼──────────┼──────────┼──────┤
 │ ユーザー指摘回数         │ -        │ -        │ -    │
 ├──────────────────────────┼──────────┼──────────┼──────┤
 │ 完了までのステップ数     │ -        │ -        │ -    │
 ├──────────────────────────┼──────────┼──────────┼──────┤
 │ compact回数              │ -        │ -        │ -    │
 └──────────────────────────┴──────────┴──────────┴──────┘
 期待される結果

 - KIRO-029: マーカー表示あり、Task tool自動使用、ログサイズ小
 - KIRO-030: マーカーなし、手動判断、ログサイズ大（肥大化）

 ---
 検証項目1: ユニットテスト（事前確認）

 実行コマンド

 source sam-env/bin/activate
 pytest tests/test_workflow_cli_subagent.py -v

 期待結果

 - 12テストケース全て通過
 - step_requires_investigation()関数が正しく動作
 - マーカー出力ロジックが正しく動作

 ---
 実行順序まとめ

 1. 事前確認: ユニットテスト実行（現セッション）
 2. KIRO-029実行: 新規セッション、feature/KIRO-024-reapplyベース
 3. KIRO-030実行: 新規セッション、mainベース
 4. 定量比較分析: ログ収集後、分析スクリプト実行
 5. 結果レポート: 比較表作成、効果検証

 ---
 補足: チケット内容（共通）

 tracker_id: KIRO-029 / KIRO-030
 description: WorkspaceConfig.get_workspace_base()の多作者対応バグ修正

 【現象】
 異なる作者のトラッカー検証時に間違った作者のワークスペースパスが使用される

 【根本原因】
 get_workspace_base()が最新更新トラッカーの作者を返す

 【修正箇所】
 workflow_controller.pyの3関数:
 6. _check_final_approval_conditions()
 7. _get_step_artifacts()
 8. _generate_step_actions()

 【修正方法】
 get_workspace_config(tracker_id)を使用してトラッカー固有パスを取得

---


❯ 基本的にOKです。一点追加。新規追加修正があるなら、その修正ごとにユニットテストを作ってそれも通るようにして。ユニットテストは可能な限りいろ
  んなパターンで作って,この内容もplan,に追加してください                                                                  
❯ ワークフロー継続ですが、画像抽出もやってください。デフォルトは基本画像抽出するとCLAUDE.mdにも記載してました


  ❯ kana05というのはどこかのハードコーディングですか？サブエージェントに依頼して調査してください過不足や不明点あれば実行前にヒアリングして        ください。これはサブエージェントでも同様に、サブエージェント内で確認することがあれば、サブエージェントだけでなく呼び出し元のエージェン        トも一時停止してヒアリングして


  1. kana05ハードコーディングの修正は必要ですか？
    - 今回のKIRO-029で修正すべきか、別チケットで対応するか
今回のKIRO-029で修正（サブエージェントに依頼してください）

  2. KIRO-029の画像抽出はどのデータを使用しますか？
    - 選択肢A: yado/org/kana05の画像を使用（既存データ）
    - 選択肢B: zundamon/10_zundamonの画像を使用（KIRO-024で使用済み）
    - 選択肢C: input_pathを手動で更新して指定のディレクトリを使用
    - 選択肢D: 画像抽出ステップをスキップ（検証目的なら不要）
選択肢C
input_path　
/mnt/c/AItools/lora/train/zundamon/org/kana05
を

/mnt/c/AItools/lora/train/zundamon/org/10_zundamon

----

 各stepや、statusごとのに ワークフローの進捗 がわかるようにする
  案1 標準出力
  案2コンテキストウィンドウを消費させるのならば、  各チケットごとにs o w ファイルを作っているのでそこで状態としてステップごとにアップデートを行う.SOWのテンプレートにこの表を入れておくこと。
  

動作
 例えば実装である「implementation」 ステップが開始したらこのような形で表に出す
 
[x]  branch_verification
[x] sam_env_check
[x] google_sheets_sync
[x] sow_creation
[] implementation
[] testing
[] subagent_extraction
[] waiting_for_subagent
[] subagent_validation
[] quality_workflow
[] dashboard_generation 
[] final_approval
[] completed

 実装が終わってテストが開始するならば、テストステップが開始されることなので表である進捗も更新される。
 [x]  branch_verification
[x] sam_env_check
[x] google_sheets_sync
[x] sow_creation
[x] implementation
[] testing
[] subagent_extraction
[] waiting_for_subagent
[] subagent_validation
[] quality_workflow
[] dashboard_generation 
[] final_approval
[] completed

テストは各ステップごとの出力内容とSOWファイルの更新が正しくされているかの確認をすること